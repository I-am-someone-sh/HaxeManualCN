<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    <title>Haxe 中文手册 |  </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"path":"3.类型系统/3.4.变异/3.4.变异.html","title":""},"data":{"navigation":{"logo":{"text":"Haxe 中文手册","type":"link","path":"index.html"},"main":[{"text":"目录","type":"label","children":null},{"text":"2.类型","type":"link","path":"2.类型/2.类型.html","children":[{"text":"2.1.基本类型","type":"link","path":"2.类型/2.1.基本类型/2.1.基本类型.html","children":[{"text":"2.1.1.数值类型","type":"link","path":"2.类型/2.1.基本类型/2.1.1.数值类型.html"},{"text":"2.1.2.溢出","type":"link","path":"2.类型/2.1.基本类型/2.1.2.溢出.html"},{"text":"2.1.3.数值运算符","type":"link","path":"2.类型/2.1.基本类型/2.1.3.数值运算符.html"},{"text":"2.1.4.Bool类型","type":"link","path":"2.类型/2.1.基本类型/2.1.4.Bool类型.html"},{"text":"2.1.5.Void类型","type":"link","path":"2.类型/2.1.基本类型/2.1.5.Void类型.html"}]},{"text":"2.2.为空性","type":"link","path":"2.类型/2.2.为空性/2.2.为空性.html","children":[{"text":"2.2.1.可选参数和为空性","type":"link","path":"2.类型/2.2.为空性/2.2.1.可选参数和为空性.html"}]},{"text":"2.3.类实例","type":"link","path":"2.类型/2.3.类实例/2.3.类实例.html"},{"text":"2.4.枚举实例","type":"link","path":"2.类型/2.3.类实例/2.4.枚举实例.html"},{"text":"2.5.匿名结构","type":"link","path":"2.类型/2.5.匿名结构/2.5.匿名结构.html","children":[{"text":"2.5.1.结构值的JSON形式","type":"link","path":"2.类型/2.5.匿名结构/2.5.1.结构值的JSON形式.html"},{"text":"2.5.2.结构类型的类记法","type":"link","path":"2.类型/2.5.匿名结构/2.5.2.结构类型的类记法.html"},{"text":"2.5.3.可选字段","type":"link","path":"2.类型/2.5.匿名结构/2.5.3.可选字段.html"},{"text":"2.5.4.性能影响","type":"link","path":"2.类型/2.5.匿名结构/2.5.4.性能影响.html"},{"text":"2.5.5.扩展","type":"link","path":"2.类型/2.5.匿名结构/2.5.5.扩展.html"}]},{"text":"2.6.函数类型","type":"link","path":"2.类型/2.6.函数类型/2.6.函数类型.html"},{"text":"2.7.动态类型","type":"link","path":"2.类型/2.7.动态类型/2.7.动态类型.html"},{"text":"2.8.抽象类型","type":"link","path":"2.类型/2.8.抽象类型/2.8.抽象类型.html"},{"text":"2.9.单形","type":"link","path":"2.类型/2.9.单形/2.9.单形.html"}]},{"text":"3.类型系统","type":"link","path":"3.类型系统/3.类型系统.html","children":[{"text":"3.1.Typedef","type":"link","path":"3.类型系统/3.1.Typedef/3.1.Typedef.html"},{"text":"3.2.类型参数","type":"link","path":"3.类型系统/3.2.类型参数/3.2.类型参数.html"},{"text":"3.3.泛型","type":"link","path":"3.类型系统/3.3.泛型/3.3.泛型.html"},{"text":"3.4.变异","type":"link","path":"3.类型系统/3.4.变异/3.4.变异.html"},{"text":"3.5.一致性检查","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.一致性检查.html","children":[{"text":"3.5.1.类与接口","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.1.类与接口.html"},{"text":"3.5.2.结构子类型","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.2.结构子类型.html"},{"text":"3.5.3.单形","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.3.单形.html"},{"text":"3.5.4.函数返回","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.4.函数返回.html"},{"text":"3.5.5.通用基本类型","type":"link","path":"3.类型系统/3.5.一致性检查/3.5.5.通用基本类型.html"}]},{"text":"3.6.类型推断","type":"link","path":"3.类型系统/3.6.类型推断/3.6.类型推断.html"},{"text":"3.7.模块和路径","type":"link","path":"3.类型系统/3.7.模块和路径/3.7.模块和路径.html"}]},{"text":"4.类字段","type":"link","path":"4.类字段/4.类字段.html"},{"text":"5.表达式","type":"link","path":"5.表达式/5.表达式.html"},{"text":"6.语言特性","type":"link","path":"6.语言特性/6.语言特性.html"},{"text":"7.编译器用法","type":"link","path":"7.编译器用法/7.编译器用法.html"},{"text":"8.编译器功能","type":"link","path":"8.编译器功能/8.编译器功能.html"},{"text":"9.宏","type":"link","path":"9.宏/9.宏.html"},{"text":"10.标准库","type":"link","path":"10.标准库/10.标准库.html"},{"text":"支持与反馈","type":"label","children":null},{"text":"Repository Link","type":"link","path":"https://github.com/NulllStack/HaxeManualCN"}]}},"config":{"timezone":"UTC","root":"/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/index.html" class="doc-navbar__logo"><img src="/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">Haxe 中文手册</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="3-4-变异"><a href="#3-4-变异" class="headerlink" title="3.4.变异"></a>3.4.变异</h1><p>虽然变异也在其它地方意义重大，但是它特别经常和类型参数一起出现，并像一个惊喜。此外，非常容易触发变异错误：</p>
<blockquote>
<p>While variance is also relevant in other places, it occurs particularly often with type parameters and comes as a surprise in this context. Additionally, it is very easy to trigger variance errors:</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span></span>() &#123; &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Base</span></span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span> </span>() &#123; </span><br><span class="line">        <span class="keyword">var</span> children = [<span class="keyword">new</span> <span class="type">Child</span>()];</span><br><span class="line">        <span class="comment">// Array&lt;Child&gt; should be Array&lt;Base&gt;</span></span><br><span class="line">        <span class="comment">// Type parameters are invariant </span></span><br><span class="line">        <span class="comment">// Child should be Base </span></span><br><span class="line">        <span class="keyword">var</span> bases:<span class="type">Array</span>&lt;Base&gt; = children;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然，一个 Array 不能被分配到一个 Array，即使 Child可以被分配到Base。原因可能比较意外：因为 array 可以被写入，如通过它们的 push() 方法。忽略变异错误非常容易产生问题：</p>
<blockquote>
<p>Apparently,an <code>Array</code> cannot be assigned to an <code>Array</code>,even though <code>Child</code> can be assigned to <code>Base</code>. The reason for this might be somewhat unexpected: It is not allowed because arrays can be written to, e.g. via their <code>push()</code> method. It is easy to generate problems by ignoring variance errors:</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span></span>() &#123; &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Base</span></span> </span>&#123; &#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherChild</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Base</span></span> </span>&#123; &#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span> </span>() &#123; </span><br><span class="line">        <span class="keyword">var</span> children = [<span class="keyword">new</span> <span class="type">Child</span>()]; </span><br><span class="line">        <span class="comment">// subvert type checker </span></span><br><span class="line">        <span class="keyword">var</span> bases:<span class="type">Array</span>&lt;Base&gt; = <span class="keyword">cast</span> children; </span><br><span class="line">        bases.push(<span class="keyword">new</span> <span class="type">OtherChild</span>());</span><br><span class="line">        <span class="keyword">for</span>(child <span class="keyword">in</span> children) &#123; </span><br><span class="line">            <span class="built_in">trace</span>(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们使用 cast（第5.23节）破坏了类型检查，因此允许了注释行后的赋值。我们保存一个引用 bases 到原始的数组，类型为 Array。这使的推送另一个兼容Base的类型（OtherChild）到了数组。然而，我们原始的引用 children 仍然是 Array类型，当我们在迭代它的一个元素的时候遇到 OtherChild实例就会出现问题。</p>
<blockquote>
<p>Here we subvert the type checker by using a cast (5.23), thus allowing the assignment after the commented line. With that we hold a reference <code>bases</code> to the original array, typed as <code>Array</code>. This allows pushing another type compatible with <code>Base</code> (OtherChild) onto that array. However,our original reference <code>children</code> is still of type <code>Array</code> and things go bad when we encounter the <code>OtherChild</code> instance in one of its elements while iterating.</p>
</blockquote>
<p>如果 Array 没有 push() 方法，没有其它修改的手段，赋值则变得安全，因为没有矛盾的类型被添加到它。在Haxe中，我们可以使用结构子类型化（第3.5.2节）相应的限制类型来实现这个。</p>
<blockquote>
<p>If Array had no <code>push()</code> method and no other means of modiﬁcation,the assignment would be safe because no incompatible type could be added to it. In Haxe, we can achieve this by restricting the type accordingly using structural subtyping (3.5.2):</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span></span>() &#123; &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Base</span></span> </span>&#123; &#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> MyArray&lt;T&gt; = &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span></span>():<span class="type">T</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span> </span>() &#123;</span><br><span class="line">        <span class="keyword">var</span> a = [<span class="keyword">new</span> <span class="type">Child</span>()];</span><br><span class="line">        <span class="keyword">var</span> b:<span class="type">MyArray</span>&lt;Base&gt; = a; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以安全的分配 b 作为 MyArray类型，MyArray 只有一个 pop() 方法。没有为 MyArray定义可以用来添加冲突类型的方法，因此被认为是协变的。</p>
<blockquote>
<p>We can safely assign with <code>b</code> being typed as <code>MyArray</code> and <code>MyArray</code> only having a <code>pop()</code> method. There is no method deﬁned on <code>MyArray</code> which could be used to add incompatible types, it is thus said to be covariant.</p>
</blockquote>
<p><strong>协变</strong></p>
<blockquote>
<p>定义：协变<br>一种复合类型，如果它的组成类型可以被分配为缺少特定组件，如它们是只读，不允许写时，则被认为是协变的。<br>[warning] Deﬁnition: Covariance<br>A compound type is considered covariant if its component types can be assigned to less speciﬁc components, i.e. if they are only read, but never written.</p>
</blockquote>
<blockquote>
<p>定义：抗变性<br>一个复合类型，如果它的组件类型可以被分配得为缺少通用的组件，如它们只写，但是不读，则被认为是抗变。<br>[warning] Deﬁnition: Contravariance<br>A compound type is considered contravariant if its component types can be assigned to less generic components, i.e. if they are only written, but never read.</p>
</blockquote>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/script/doc.js"></script>

    

  </body>
</html>
